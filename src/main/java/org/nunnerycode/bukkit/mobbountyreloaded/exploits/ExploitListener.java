package org.nunnerycode.bukkit.mobbountyreloaded.exploits;

import org.bukkit.Location;
import org.bukkit.Material;
import org.bukkit.block.Block;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.nunnerycode.bukkit.mobbountyreloaded.MobBountyReloadedPlugin;
import org.nunnerycode.bukkit.mobbountyreloaded.events.MobBountyReloadedRewardEvent;

import java.util.HashMap;
import java.util.Map;

public final class ExploitListener implements Listener {

    private MobBountyReloadedPlugin plugin;
    private Map<String, PlayerKillData> playerKillDataMap;

    public ExploitListener(MobBountyReloadedPlugin plugin) {
        this.plugin = plugin;
        playerKillDataMap = new HashMap<>();
    }

    @EventHandler
    public void onMobBountyReloadedRewardEvent(MobBountyReloadedRewardEvent event) {
        Player player = event.getPlayer();
        PlayerKillData playerKillData;
        if (playerKillDataMap.containsKey(player.getName())) {
            playerKillData = playerKillDataMap.get(player.getName());
        } else {
            playerKillData = new PlayerKillData();
        }
        if (plugin.getIvorySettings().getBoolean("exploits.depreciative-return.enabled", false)) {
            long timestamp = System.currentTimeMillis() / 1000; // Timestamp in seconds
            if (isDepreciativeReturnMobType(event, playerKillData) &&
                    isWithinTimeout(playerKillData, timestamp) && isWithinRange(playerKillData.getLastKillLocation(),
                    event.getEntity().getLocation())) {
                double newPercentage = playerKillData.getLastKillPercentage() - plugin.getIvorySettings()
                        .getDouble("exploits.depreciative-return.percentage", 0.1);
                double minThreshold = plugin.getIvorySettings().getDouble("exploits.depreciative-return.min", -2.0);
                if (newPercentage < minThreshold) {
                    newPercentage = minThreshold;
                }
                playerKillData.setLastKillPercentage(newPercentage);
                event.setAmount(event.getAmount() * playerKillData.getLastKillPercentage());
            } else {
                playerKillData.setLastKillPercentage(1.0);
                playerKillData.setLastKillType(event.getEntity().getType());
            }
            playerKillData.setLastKillTimestamp(timestamp);
        }
        playerKillData.setLastKillLocation(event.getEntity().getLocation());
        if (plugin.getIvorySettings().getBoolean("exploits.mob-spawner.enabled", false)) {
            int radius = plugin.getIvorySettings().getInt("exploits.mob-spawner.radius", 5);
            double percentage =
                    plugin.getIvorySettings().getDouble("exploits.mob-spawner.percentage", 0.5);
            if (isMaterialWithinRadius(event.getEntity().getLocation(), Material.MOB_SPAWNER, radius)) {
                event.setAmount(event.getAmount() * percentage);
            }
        }

        playerKillDataMap.put(player.getName(), playerKillData);
    }

    private boolean isWithinRange(Location lastLocation, Location currentLocation) {
        if (lastLocation == null || currentLocation == null) {
            return false;
        }
        double distance = plugin.getIvorySettings().getDouble("exploits.depreciative-return.distance", 17.0);
        return lastLocation.distanceSquared(currentLocation) < distance * distance;
    }

    private boolean isWithinTimeout(PlayerKillData playerKillData, long timestamp) {
        return playerKillData != null &&
                ((timestamp - playerKillData.getLastKillTimestamp()) < plugin.getIvorySettings().getInt("exploits.depreciative-return.timeout", 180));
    }

    private boolean isMaterialWithinRadius(Location location, Material material, int radius) {
        if (location == null || material == null) {
            return false;
        }
        for (int x = -radius; x <= radius; x++) {
            for (int y = -radius; y <= radius; y++) {
                for (int z = -radius; z <= radius; z++) {
                    Block b =
                            new Location(location.getWorld(), location.getX() + x, location.getY() + y,
                                    location.getZ() + z).getBlock();
                    if (b.getType() == material) {
                        return true;
                    }
                }
            }
        }
        return false;
    }

    private boolean isDepreciativeReturnMobType(MobBountyReloadedRewardEvent event, PlayerKillData data) {
        return !(event == null || data == null) &&
                (plugin.getIvorySettings().getString("exploits.depreciative-return.type", "ALL").equalsIgnoreCase("ALL") ||
                        event.getEntity().getType() == data.getLastKillType());
    }

}
